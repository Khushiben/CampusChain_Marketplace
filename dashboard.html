<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Decentralized College Marketplace</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo">College Marketplace</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="marketplace.html">Marketplace</a></li>
      <li><a href="list-item.html">List Item</a></li>
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><button id="connectWalletBtn">Connect Wallet</button></li>
    </ul>
  </nav>

  <!-- Dashboard Section -->
  <section class="marketplace dashboard-section">
    <h2>ðŸ“Š My Dashboard</h2>
    <div class="dashboard-stats">
      <div class="stat-card">
        <h3 id="totalItems">0</h3>
        <p>Total Items Listed</p>
      </div>
      <div class="stat-card">
        <h3 id="totalValue">0</h3>
        <p>Total ETH Value</p>
      </div>
    </div>

    <h2 style="margin-top:40px;">My Listed Items</h2>
    <div id="myItemsContainer" class="items-grid"></div>
  </section>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Decentralized College Marketplace | Built for Hackathon</p>
  </footer>

  <script src="js/app.js"></script>
  <script>
    // Called when wallet connects (from app.js)
    function onWalletConnected(address) {
      // reload dashboard items when wallet connection happens
      loadDashboardItems();
    }

    function loadDashboardItems() {
      const myItemsContainer = document.getElementById("myItemsContainer");
      const totalItems = document.getElementById("totalItems");
      const totalValue = document.getElementById("totalValue");

      myItemsContainer.innerHTML = "";

      const userAddress = sessionStorage.getItem("userAddress");
      if (!userAddress) {
        myItemsContainer.innerHTML = "<p>Please connect your wallet to view your items.</p>";
        totalItems.textContent = "0";
        totalValue.textContent = "0";
        return;
      }

      const listedItems = getListedItems();
      const myItems = listedItems.filter(item => item.owner === userAddress);

      totalItems.textContent = myItems.length;
      let value = 0;

      if (myItems.length === 0) {
        myItemsContainer.innerHTML = "<p>You haven't listed any items yet.</p>";
        totalValue.textContent = "0";
        return;
      }

      myItems.forEach(item => {
        value += parseFloat(item.price || 0);
        const card = document.createElement("div");
        card.className = "item-card dashboard-card";
        card.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div class="item-info">
            <h4>${item.name}</h4>
            <p>${item.description}</p>
            <p><strong>Price:</strong> ${item.price} ETH</p>
            <div class="item-actions">
              <button class="edit-btn" data-id="${item.id}">Edit</button>
              <button class="delete-btn" data-id="${item.id}">Delete</button>
            </div>
          </div>
        `;
        myItemsContainer.appendChild(card);
      });

      totalValue.textContent = value.toFixed(3);

      // attach handlers
      myItemsContainer.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          if (!confirm("Are you sure you want to delete this item?")) return;
          deleteListedItemById(id);
          loadDashboardItems();
        });
      });

      myItemsContainer.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          // load item and prompt edits (keeps it simple)
          const items = getListedItems();
          const it = items.find(x => x.id === id);
          if (!it) return alert("Item not found.");

          const newName = prompt("Edit Item Name:", it.name);
          if (newName === null) return; // cancelled
          const newDesc = prompt("Edit Description:", it.description);
          if (newDesc === null) return;
          const newPrice = prompt("Edit Price (ETH):", it.price);
          if (newPrice === null) return;
          const newImg = prompt("Edit Image URL:", it.img);
          if (newImg === null) return;

          // Basic validation
          if (!newName.trim() || !newDesc.trim() || !newPrice.trim() || !newImg.trim()) {
            return alert("All fields required.");
          }

          updateListedItemById(id, {
            name: newName.trim(),
            description: newDesc.trim(),
            price: newPrice.trim(),
            img: newImg.trim()
          });

          loadDashboardItems();
        });
      });
    }

    window.addEventListener("load", loadDashboardItems);
  </script>
</body>
</html>
